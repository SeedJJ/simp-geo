<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Host - Local Geo Party</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #f6f7fb;
            --card: #ffffff;
            --text: #101828;
            --muted: #475467;
            --border: #e4e7ec;
            --accent: #2563eb;
            --accent2: #1d4ed8;
            --good: #067647;
            --bad: #b42318;
            --radius: 14px;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            color: var(--text);
            background: linear-gradient(180deg, #f6f7fb, #eef2ff);
            padding: 24px 18px;
        }

        .wrap {
            max-width: 1150px;
            margin: 0 auto;
        }

        h1 {
            margin: 0 0 6px 0;
            font-size: 26px;
            letter-spacing: -0.02em;
        }

        .muted {
            color: var(--muted);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        @media (max-width: 980px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 18px;
            border: 1px solid var(--border);
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        input, select {
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: white;
            color: var(--text);
            outline: none;
        }

            input::placeholder {
                color: #98a2b3;
            }

        button {
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--accent);
            color: white;
            cursor: pointer;
            font-weight: 800;
        }

            button:hover {
                background: var(--accent2);
            }

        .btn-ghost {
            background: white;
            color: var(--text);
        }

            .btn-ghost:hover {
                background: #f2f4f7;
            }

        .err {
            color: var(--bad);
            margin: 10px 0 0 0;
            font-weight: 700;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px 6px;
            border-bottom: 1px solid var(--border);
            text-align: left;
            font-size: 14px;
        }

        code {
            background: #f2f4f7;
            padding: 2px 6px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .tag {
            display: inline-flex;
            padding: 4px 10px;
            border-radius: 999px;
            background: #eff6ff;
            color: #1d4ed8;
            font-weight: 800;
            font-size: 12px;
            border: 1px solid #dbeafe;
        }

        img {
            max-width: 100%;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 900;
        }

            a:hover {
                text-decoration: underline;
            }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="row" style="justify-content:space-between; align-items:flex-end;">
            <div>
                <h1>SIMP GeoGuesser</h1>
                <div class="muted">A Customizable GeoGuessing Game made for SIMP</div>
            </div>
            <div class="row">
                <a class="tag" href="{{url_for('leaderboard')}}">Leaderboard</a>
            </div>
        </div>

        {% if msg %}<p class="err">{{msg}}</p>{% endif %}

        <div class="grid" style="margin-top:14px;">
            <div class="card">
                <div class="tag">Players</div>
                <div class="muted" style="margin-top:8px;">Add Player names(Can add during round)</div>
                <form method="post" class="row" style="margin-top:12px;">
                    <input type="hidden" name="action" value="add_player" />
                    <input name="player_name" placeholder="e.g. Roger" />
                    <button type="submit">Add</button>
                </form>
                {% if players %}
                <table style="margin-top:10px;">
                    <tr><th>Name</th><th></th></tr>
                    {% for p in players %}
                    <tr>
                        <td>{{p}}</td>
                        <td>
                            <form method="post" style="margin:0">
                                <input type="hidden" name="action" value="remove_player" />
                                <input type="hidden" name="player_name" value="{{p}}" />
                                <button class="btn-ghost" type="submit">Remove</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
                {% else %}
                <p class="muted" style="margin-top:10px;">No players yet.</p>
                {% endif %}
            </div>

            <div class="card">
                <div class="tag">Rounds</div>
                <div class="muted" style="margin-top:8px;">Each round only needs <b>one image</b>: the overall map.</div>
                <form method="post" enctype="multipart/form-data" class="row" style="margin-top:12px;">
                    <input type="hidden" name="action" value="add_round" />
                    <input type="file" name="map_image" accept=".png,.jpg,.jpeg,.webp" required />
                    <button type="submit">Add round</button>
                </form>
                {% if rounds %}
                <table style="margin-top:10px;">
                    <tr><th>#</th><th>Map</th><th>Answer</th><th>Play link</th><th></th></tr>
                    {% for rd in rounds %}
                    <tr>
                        <td>{{loop.index0}}</td>
                        <td><code>{{rd.map_filename}}</code></td>

                        <td>
                            {% if rd.answer_xy %}
                            <span class="tag" style="background:#ecfdf3;border-color:#abefc6;color:#067647;">set ✅</span>
                            {% else %}
                            <span class="tag" style="background:#fff1f3;border-color:#fecdd6;color:#b42318;">not set</span>
                            {% endif %}
                        </td>

                        <td>
                            {% if rd.answer_xy %}
                            <a class="tag" href="{{ url_for('public_round', round_id=rd.id) }}" target="_blank">Open play</a>
                            {% else %}
                            <span class="tag" style="background:#f2f4f7;border-color:#e4e7ec;color:#475467;">disabled</span>
                            {% endif %}
                        </td>

                        <td>
                            <form method="post" style="margin:0">
                                <input type="hidden" name="action" value="goto_round" />
                                <input type="hidden" name="round_index" value="{{loop.index0}}" />
                                <button class="btn-ghost" type="submit">Open</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
                {% else %}
                <p class="muted" style="margin-top:10px;">No rounds yet.</p>
                {% endif %}
            </div>
        </div>

        <div class="card" style="margin-top:14px;">
            <div class="tag">Current Round</div>
            {% if not current %}
            <p class="muted" style="margin-top:10px;">Add at least 1 round to start.</p>
            {% else %}
            <div class="row" style="justify-content:space-between; margin-top:10px;">
                <div class="muted">Round index: <code>{{round_index}}</code> · Map size: <code>{{current.map_size[0]}}×{{current.map_size[1]}}</code></div>
                <div class="row">
                    <a class="tag" href="{{url_for('set_answer', round_id=current.id)}}">Set answer</a>

                    {% if current.answer_xy %}
                    <a class="tag" href="{{url_for('public_round', round_id=current.id)}}" target="_blank">
                        Player link
                    </a>
                    {% else %}
                    <span class="tag" style="background:#f2f4f7;border-color:#e4e7ec;color:#475467;">
                        Player link disabled
                    </span>
                    {% endif %}
                </div>
            </div>

            <div style="margin-top:12px;">
                <div class="muted" style="margin-bottom:10px;">Map preview</div>

                <div id="answerPreviewWrap" style="position:relative; display:inline-block; max-width:100%;">
                    <img id="answerPreviewImg" src="{{url_for('uploads', filename=current.map_filename)}}" />

                    {# Red answer pin overlay (host only) #}
                    {% if current.answer_xy %}
                    <svg id="answerPreviewSvg" style="position:absolute; inset:0; width:100%; height:100%; pointer-events:none;">
                        <g id="answerPin">
                            <path id="answerTail" d="" fill="rgba(220,38,38,0.98)" stroke="rgba(16,24,40,0.18)" stroke-width="2"></path>
                            <circle id="answerOuter" cx="0" cy="0" r="11" fill="rgba(255,255,255,0.98)" stroke="rgba(16,24,40,0.18)" stroke-width="2"></circle>
                            <circle id="answerInner" cx="0" cy="0" r="4" fill="rgba(220,38,38,0.98)" stroke="rgba(16,24,40,0.18)" stroke-width="1"></circle>
                        </g>
                    </svg>
                    {% endif %}
                </div>
            </div>

            {% if current.answer_xy %}
            <script>
                (function(){
                  const img = document.getElementById("answerPreviewImg");
                  const outer = document.getElementById("answerOuter");
                  const inner = document.getElementById("answerInner");
                  const tail  = document.getElementById("answerTail");

                  const ax = Number("{{current.answer_xy[0]}}");
                  const ay = Number("{{current.answer_xy[1]}}");

                  function layout(){
                    if(!img || !img.complete) return;

                    const rect = img.getBoundingClientRect();
                    const scaleX = rect.width / img.naturalWidth;
                    const scaleY = rect.height / img.naturalHeight;

                    const cx = ax * scaleX;
                    const cy = ay * scaleY;

                    outer.setAttribute("cx", cx);
                    outer.setAttribute("cy", cy);
                    inner.setAttribute("cx", cx);
                    inner.setAttribute("cy", cy);

                    // small triangle tail
                    const d = `M ${cx} ${cy+11} L ${cx-6} ${cy+25} L ${cx+6} ${cy+25} Z`;
                    tail.setAttribute("d", d);
                  }

                  img.addEventListener("load", layout);
                  window.addEventListener("resize", layout);
                  // in case cached
                  setTimeout(layout, 0);
                })();
            </script>
            {% endif %}

            <hr style="border:none; height:1px; background:var(--border); margin:14px 0;">
            <form method="post" class="row">
                <input type="hidden" name="action" value="reset_game" />
                <button class="btn-ghost" type="submit" onclick="return confirm('Reset players & rounds?')">Reset players & rounds</button>
            </form>
            {% endif %}
        </div>

    </div>
</body>
</html>